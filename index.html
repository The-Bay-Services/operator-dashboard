<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bay Services Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .tab-button.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            color: #2563eb;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 600px;
            position: relative;
        }
        .trash-icon {
            cursor: pointer;
            color: #9ca3af;
            display: inline-block;
            margin-left: 8px;
            visibility: hidden;
        }
        th:hover .trash-icon {
            visibility: visible;
        }
        .trash-icon:hover {
            color: #ef4444;
        }
         /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch, query, where
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Your Firebase configuration has been successfully embedded.
        const firebaseConfig = {
            apiKey: "AIzaSyDLuxy6E6pOA6HYjeD6qp_5r0ANleHCnp8",
            authDomain: "the-bay-services.firebaseapp.com",
            projectId: "the-bay-services",
            storageBucket: "the-bay-services.appspot.com",
            messagingSenderId: "194632911643",
            appId: "1:194632911643:web:44ddedf76d4bc503c6a1be",
            measurementId: "G-92QZ39WTVR"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
        
        window.fb = { db, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, writeBatch, query, where };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, Fragment } = React;
        
        const initialData = {
            dispatchingSchedule: {
                headers: ["Days", "Vuqar/David", "Kanan/Kenny", "Nahida/Emma", "Narmina/Nora", "Orxan/Eric"],
                rows: [
                    ["Monday", "8:00AM-11:00AM", "11:00AM-1:00PM", "1:00PM-3:00PM", "3:00PM-8:00PM", "8:00PM-10:00PM"],
                    ["Tuesday", "8:00AM-11:00AM", "11:00AM-1:00PM", "1:00PM-3:00PM", "3:00PM-8:00PM", "8:00PM-10:00PM"],
                    ["Wednesday", "8:00AM-11:00AM", "11:00AM-1:00PM", "1:00PM-3:00PM", "3:00PM-8:00PM", "8:00PM-10:00PM"],
                    ["Thursday", "8:00AM-11:00AM", "11:00AM-1:00PM", "1:00PM-3:00PM", "3:00PM-8:00PM", "8:00PM-10:00PM"],
                    ["Friday", "8:00AM-11:00AM", "11:00AM-1:00PM", "1:00PM-3:00PM", "3:00PM-8:00PM", "8:00PM-10:00PM"],
                    ["Saturday", "OFF", "08:00AM-7:00PM", "OFF", "OFF", "OFF"],
                    ["Sunday", "OFF", "OFF", "OFF", "3:00PM-8:00PM", "8:00PM-10:00PM"]
                ]
            },
            managementSchedule: {
                headers: ["Days", "Vuqar/David", "Nahida/Emma"],
                rows: [
                    ["Monday", "8:00AM-12:00PM", "12:00PM-4:00PM"],
                    ["Tuesday", "8:00AM-12:00PM", "12:00PM-4:00PM"],
                    ["Wednesday", "8:00AM-12:00PM", "12:00PM-4:00PM"],
                    ["Thursday", "8:00AM-12:00PM", "12:00PM-4:00PM"],
                    ["Friday", "8:00AM-12:00PM", "12:00PM-4:00PM"],
                    ["Saturday", "OFF", "OFF"],
                    ["Sunday", "OFF", "OFF"]
                ]
            },
            automaticAnswers: [
                { title: 'Air Duct cleaning', blocks: ['Hi       ,\n\nThis is [NAME] with Bay Services and thank you for considering air duct cleaning services with us.', '1ï¸âƒ£ -- The price for the full HVAC system cleaning for up to 10 vents will be $340 ($25 for each additional).', '2ï¸âƒ£ -- Please kindly note that you will always get a free dryer vent, kitchen exhaust/range, and chimney/fireplace inspection.', 'ðŸ“ž â€“You can always give me a call/text me at (650)731-7359 to make an appointment.'] },
                { title: 'Chimney /fireplace cleaning', blocks: ['Hi       ,\n\nThis is [NAME] with Bay Services and thank you for considering Chimney/fireplace cleaning services with us.', '1ï¸âƒ£ â€” The price of the chimney / fireplace inspection and cleaning will be $169.', '2ï¸âƒ£  â€” Please kindly note that  you will always get a free dryer vent, kitchen exhaust/range and HVAC vents/registers inspection.', 'ðŸ“ž â€“You can always give me a call/text me at (650)731-7359 to make an appointment.'] },
                { title: 'Dryer vent cleaning', blocks: ['Hi       ,\n\nThis is [NAME] with Bay Services and thank you for considering dryer vent & duct cleaning services with us.', '1ï¸âƒ£ -- The price of a dryer vent cleaning will be $139', '2ï¸âƒ£  -- Please kindly note that  you will always get a free chimney / fireplace , kitchen exhaust/range and HVAC vents/registers inspection.', 'ðŸ“ž â€“You can always give me a call/text me at (650)731-7359 to make an appointment.'] },
            ],
            propertyManagement: [
                { "Company": "Agile Appliance", "Invoicing Email": "", "Phone": "(650) 625-7475", "Representative": "", "Position": "", "Email": ""},
                { "Company": "AmeFix Home Solutions", "Invoicing Email": "vendor.amefix@gmail.com", "Phone": "(978) 715-0348", "Representative": "Sarah Scarlet", "Position": "", "Email": ""},
                { "Company": "Honey Homes", "Invoicing Email": "invoices@honeyhomes.com", "Phone": "", "Representative": "", "Position": "", "Email": ""},
            ],
            outstandingPayments: [
                { "CUSTOMER": "W2 PROPERTIES #205", "PHONE NUMBER": "", "EMAIL": "noe@w2propertymgt.com", "AMMOUNT": 749.76, "INVOICE No": "9621", "STATUS": "OUTSTANDING", "INVOICE DATE": "7/1/2025"},
                { "CUSTOMER": "Joann Dethman.", "PHONE NUMBER": "(650) 269-0659", "EMAIL": "joanndethman@gmail.com", "AMMOUNT": 339, "INVOICE No": "9577", "STATUS": "OUTSTANDING", "INVOICE DATE": "7/4/2025"},
                { "CUSTOMER": "Agile Appliance", "PHONE NUMBER": "(650) 625-7475", "EMAIL": "", "AMMOUNT": 379, "INVOICE No": "9570", "STATUS": "OUTSTANDING", "INVOICE DATE": "6/29/2025"},
            ],
             services: [
                { name: 'Dryer Vent Cleaning', what: 'Professional removal of lint, debris, and obstructions from dryer vent lines to restore proper airflow and prevent dangerous fire hazards.', signs: 'Clothes take longer to dry, Dryer feels very hot, Visible lint around vent, Lint blowing back inside', process: 'System inspection, Rotary brush cleaning, Airflow verification, Exterior cleaning', price: '$139 (side-by-side) / $199 (stacked)', duration: '~30 minutes', frequency: 'Once a year', note: 'Priority: Fire Safety.' },
                { name: 'Air Duct Cleaning', what: 'Comprehensive cleaning of HVAC system including supply/return ducts, registers, grilles, and coils to remove pollutants and improve indoor air quality and system efficiency.', signs: 'Visible dust from vents, Uneven airflow in rooms, Allergies worsen indoors, After renovation/construction', process: 'Visual inspection with cameras, Negative air pressure setup, Rotary brush scrubbing, System sanitization', price: '$339 (up to 10 vents), +$25 each additional', duration: '~1.5 hours', frequency: 'Every 3-5 years', note: 'Improves Air Quality & System Efficiency.' },
                { name: 'Chimney / Fireplace Cleaning', what: 'Thorough cleaning of chimney flue, smoke chamber, and firebox to remove creosote buildup, blockages, and soot, ensuring safe operation.', signs: 'Visible soot or creosote, Smell of smoke when not in use, Animals inside, Difficulty starting fires', process: 'System inspection & setup, Flue & smoke chamber cleaning, Firebox & damper cleaning, Final inspection', price: '$169', duration: '45-90 mins', frequency: 'Once a year', note: 'Priority: Fire Safety.' },
             ]
        };
        
        // --- Helper Functions & Hooks ---
        const useCaliforniaTime = () => {
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                const timerId = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timerId);
            }, []);

            const options = {
                timeZone: 'America/Los_Angeles',
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            };
            return new Intl.DateTimeFormat('en-US', options).format(time);
        };

        const useWeather = () => {
            const [weather, setWeather] = useState({ temp: 'N/A', forecast: 'Loading...' });

            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        const pointsResponse = await fetch('https://api.weather.gov/points/37.3541,-121.9552');
                        if (!pointsResponse.ok) throw new Error('Could not fetch weather points.');
                        const pointsData = await pointsResponse.json();
                        const forecastUrl = pointsData.properties.forecast;

                        const forecastResponse = await fetch(forecastUrl);
                        if (!forecastResponse.ok) throw new Error('Could not fetch forecast.');
                        const forecastData = await forecastResponse.json();
                        
                        const currentForecast = forecastData.properties.periods[0];
                        setWeather({
                            temp: `${currentForecast.temperature}Â°F`,
                            forecast: currentForecast.shortForecast
                        });
                    } catch (error) {
                        console.error("Weather fetch error:", error);
                        setWeather({ temp: 'N/A', forecast: 'Load failed' });
                    }
                };
                fetchWeather();
                 const interval = setInterval(fetchWeather, 600000); // Update every 10 minutes
                 return () => clearInterval(interval);
            }, []);

            return weather;
        };
        
        // --- Main Components ---
        
        function App() {
            const [role, setRole] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                const seedDatabase = async () => {
                    const checkDocRef = fb.doc(fb.db, "app_config", "isSeeded_v8"); // Use a new version flag for new data structure
                    const docSnap = await fb.getDoc(checkDocRef);

                    if (docSnap.exists() && docSnap.data().status === true) {
                        console.log("Database is already seeded.");
                        setLoading(false);
                        return;
                    }

                    console.log("Seeding database for the first time...");
                    try {
                        const batch = fb.writeBatch(fb.db);
                        
                        batch.set(fb.doc(fb.db, "schedules", "dispatchingSchedule"), {
                            headers: initialData.dispatchingSchedule.headers,
                            rowsJSON: JSON.stringify(initialData.dispatchingSchedule.rows)
                        });
                        batch.set(fb.doc(fb.db, "schedules", "managementSchedule"), {
                             headers: initialData.managementSchedule.headers,
                            rowsJSON: JSON.stringify(initialData.managementSchedule.rows)
                        });
                        
                        initialData.automaticAnswers.forEach(item => batch.set(fb.doc(fb.collection(fb.db, "automaticAnswers")), item));
                        initialData.services.forEach(item => batch.set(fb.doc(fb.collection(fb.db, "services")), item));
                        initialData.propertyManagement.forEach(item => batch.set(fb.doc(fb.collection(fb.db, "propertyManagement")), item));
                        
                        initialData.outstandingPayments.forEach(item => {
                            const docRef = fb.doc(fb.collection(fb.db, "outstandingPayments"));
                            batch.set(docRef, item);
                        });
                        
                        await batch.commit();
                        await fb.setDoc(checkDocRef, { status: true });
                        console.log("Database seeded successfully!");
                    } catch (error) {
                        console.error("Error seeding database: ", error);
                    } finally {
                        setLoading(false);
                    }
                };

                seedDatabase();
            }, []);
            
            if (loading) {
                return <div className="flex items-center justify-center h-screen"><div className="text-xl font-semibold">Loading & Initializing...</div></div>;
            }

            if (!role) {
                return <RoleSelectionScreen onSelectRole={setRole} />;
            }
            
            const PageComponent = role === 'operator' ? OperatorPage : ManagementPage;
            
            return (
                 <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8">
                    <PageComponent onSwitchRole={() => setRole(null)} currentRole={role} />
                </div>
            );
        }
        
        function RoleSelectionScreen({ onSelectRole }) {
            const [loginRole, setLoginRole] = useState(null);
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                setError('');
                
                const passwords = {
                    operator: 'Operator2026@@@',
                    management: 'Management2026@@@'
                };

                if (passwords[loginRole] === password) {
                    onSelectRole(loginRole);
                } else {
                    setError('Incorrect password. Please try again.');
                    setPassword('');
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100">
                    <img src="https://thebayservices.com/wp-content/uploads/2022/07/bay-services-logo-300x100.png" alt="The Bay Services Logo" className="mb-8 h-16"/>
                    <div className="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-lg">
                        
                        {!loginRole ? (
                            <Fragment>
                                <h2 className="text-2xl font-bold text-center text-gray-800">Select Your Role</h2>
                                <div className="flex flex-col space-y-4">
                                    <button onClick={() => setLoginRole('operator')} className="w-full px-4 py-3 text-lg font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                                        ðŸ‘¤ Operator
                                    </button>
                                    <button onClick={() => setLoginRole('management')} className="w-full px-4 py-3 text-lg font-semibold text-white bg-gray-700 rounded-lg hover:bg-gray-800">
                                        ðŸ’¼ Management
                                    </button>
                                </div>
                            </Fragment>
                        ) : (
                            <Fragment>
                                <h2 className="text-2xl font-bold text-center text-gray-800">
                                    Enter Password for <span className="capitalize">{loginRole}</span>
                                </h2>
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div>
                                        <label htmlFor="password-input" className="sr-only">Password</label>
                                        <input
                                            id="password-input"
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            className="w-full px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Password"
                                            required
                                            autoFocus
                                        />
                                    </div>
                                    {error && <p className="text-sm text-red-600 text-center">{error}</p>}
                                    <button type="submit" className="w-full px-4 py-3 text-lg font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">
                                        Login
                                    </button>
                                    <button type="button" onClick={() => { setLoginRole(null); setError(''); setPassword(''); }} 
                                            className="w-full px-4 py-2 text-sm font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300">
                                        Back to Role Selection
                                    </button>
                                </form>
                            </Fragment>
                        )}
                    </div>
                </div>
            );
        }
        
        function OperatorPage({ onSwitchRole, currentRole }) {
            const [activeTab, setActiveTab] = useState('dashboard');
            const tabs = {
                dashboard: 'Dashboard',
                automaticAnswers: 'Automatic Answers',
                serviceInfo: 'Service Info',
                propertyManagement: 'Property Management'
            };
            
            return (
                <Layout onSwitchRole={onSwitchRole} currentRole={currentRole} activeTab={activeTab} setActiveTab={setActiveTab} tabs={tabs}>
                    {activeTab === 'dashboard' && <Dashboard readonly={true} />}
                    {activeTab === 'automaticAnswers' && <AutomaticAnswers readonly={true} />}
                    {activeTab === 'serviceInfo' && <ServiceInfo readonly={true} />}
                    {activeTab === 'propertyManagement' && <PropertyManagement readonly={true}/>}
                </Layout>
            );
        }
        
        function ManagementPage({ onSwitchRole, currentRole }) {
            const [activeTab, setActiveTab] = useState('dashboard');
             const tabs = {
                dashboard: 'Dashboard',
                automaticAnswers: 'Automatic Answers',
                propertyManagement: 'Property Management',
                outstandingPayments: 'Outstanding Payments',
                serviceInfo: 'Service Info',
                administrativeFiles: 'Administrative Files'
            };
            
            return (
                 <Layout onSwitchRole={onSwitchRole} currentRole={currentRole} activeTab={activeTab} setActiveTab={setActiveTab} tabs={tabs}>
                    {activeTab === 'dashboard' && <Dashboard readonly={false} />}
                    {activeTab === 'automaticAnswers' && <AutomaticAnswers readonly={false} />}
                    {activeTab === 'propertyManagement' && <PropertyManagement readonly={false} />}
                    {activeTab === 'outstandingPayments' && <OutstandingPayments readonly={false} />}
                    {activeTab === 'serviceInfo' && <ServiceInfo readonly={false} />}
                    {activeTab === 'administrativeFiles' && <AdminFiles readonly={false} />}
                </Layout>
            );
        }
        
        function Layout({ children, onSwitchRole, currentRole, activeTab, setActiveTab, tabs }) {
             const caliTime = useCaliforniaTime();
             const weather = useWeather();
             const [onShift, setOnShift] = useState({ operators: "...", managers: "..."});
             
             const getOnShiftStaff = useCallback(() => {
                const now = new Date(new Date().toLocaleString("en-US", { timeZone: "America/Los_Angeles" }));
                const dayOfWeek = now.toLocaleString('en-US', { weekday: 'long' });

                const currentTime = now.getHours() + now.getMinutes() / 60;

                const parseTime = (timeStr) => {
                    const match = timeStr.match(/(\d+):?(\d+)?(AM|PM)/i);
                    if (!match) return null;
                    let [_, hour, minute, period] = match;
                    hour = parseInt(hour);
                    minute = minute ? parseInt(minute) : 0;
                    period = period.toUpperCase();

                    if (period === 'PM' && hour !== 12) hour += 12;
                    if (period === 'AM' && hour === 12) hour = 0;
                    return hour + minute / 60;
                };

                const findOnShift = (schedule) => {
                    if(!schedule || !schedule.rows || !schedule.headers) return "No Data";
                    const todaySchedule = schedule.rows.find(row => row[0] === dayOfWeek);
                    if (!todaySchedule) return "No Schedule";

                    let onShiftEmployees = [];
                    schedule.headers.slice(1).forEach((employee, index) => {
                        const timeSlot = todaySchedule[index + 1];
                        if (timeSlot && timeSlot.toLowerCase() !== 'off') {
                             try {
                                const [startStr, endStr] = timeSlot.split('-');
                                const startTime = parseTime(startStr);
                                const endTime = parseTime(endStr);
                                
                                if (startTime !== null && endTime !== null) {
                                    if ( (startTime <= endTime && currentTime >= startTime && currentTime < endTime) ||
                                         (startTime > endTime && (currentTime >= startTime || currentTime < endTime) ) ) {
                                       onShiftEmployees.push(employee.split('/')[0]);
                                    }
                                }
                             } catch(e) { console.error("Error parsing time slot:", timeSlot, e); }
                        }
                    });
                    return onShiftEmployees.length > 0 ? onShiftEmployees.join(', ') : "Nobody";
                };
                 
                setOnShift({
                    operators: findOnShift(initialData.dispatchingSchedule),
                    managers: findOnShift(initialData.managementSchedule)
                });
             }, []);

             useEffect(() => {
                getOnShiftStaff();
                const interval = setInterval(getOnShiftStaff, 60000);
                return () => clearInterval(interval);
             }, [getOnShiftStaff]);
            
            return (
                <div className="bg-white rounded-xl shadow-2xl overflow-hidden">
                    <header className="p-4 border-b border-gray-200 flex flex-wrap justify-between items-center bg-gray-50">
                        <img src="https://thebayservices.com/wp-content/uploads/2022/07/bay-services-logo-300x100.png" alt="Logo" className="h-12" />
                        <div className="text-center my-2 sm:my-0">
                            <div className="font-semibold text-gray-700">{caliTime}</div>
                            <div className="text-sm text-gray-500">Santa Clara, CA: {weather.temp}, {weather.forecast}</div>
                            <div className="text-xs text-gray-600 mt-1">
                                <span className="font-bold">On Shift:</span>
                                <span className="text-blue-600"> Ops: {onShift.operators}</span> | 
                                <span className="text-green-600"> Mgmt: {onShift.managers}</span>
                            </div>
                        </div>
                        <button onClick={onSwitchRole} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                            Switch Role ({currentRole})
                        </button>
                    </header>
                    <nav className="p-2 border-b border-gray-200 bg-white">
                        <div className="flex flex-wrap items-center gap-2">
                             {Object.entries(tabs).map(([key, title]) => (
                                <button key={key} onClick={() => setActiveTab(key)} 
                                        className={`tab-button text-sm font-medium border-b-2 px-4 py-2 rounded-t-md transition-all ${activeTab === key ? 'active' : 'border-transparent text-gray-500 hover:bg-gray-100 hover:text-gray-700'}`}>
                                    {title}
                                </button>
                            ))}
                        </div>
                    </nav>
                    <main className="p-6 bg-gray-50 min-h-[70vh]">{children}</main>
                </div>
            );
        }

        // --- Tab Components ---
        function Dashboard({ readonly }) {
            return (
                <div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Work Schedules</h2>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <ScheduleTable scheduleId="dispatchingSchedule" title="Operator Schedule" readonly={readonly} />
                        <ScheduleTable scheduleId="managementSchedule" title="Management Schedule" readonly={readonly} />
                    </div>
                </div>
            );
        }

        function AutomaticAnswers({ readonly = false }) {
            const [answers, setAnswers] = useState([]);
            const [selectedName, setSelectedName] = useState('Thomas');
            const [editingAnswer, setEditingAnswer] = useState(null);
            const operators = ['Thomas', 'David', 'Emma', 'Eric', 'Nora', 'Trinity', 'Kenny'];
            
            useEffect(() => {
                const answersCol = fb.collection(fb.db, "automaticAnswers");
                const unsubscribe = fb.onSnapshot(answersCol, (snapshot) => {
                    const fetchedAnswers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAnswers(fetchedAnswers);
                });
                return () => unsubscribe();
            }, []);

            const openAddModal = () => {
                setEditingAnswer({ title: '', blocks: [''] });
            };
            
            const handleEditClick = (answer) => {
                const normalizedAnswer = {
                    ...answer,
                    // This ensures compatibility with old records that only have a `text` field
                    blocks: answer.blocks || [answer.text || '']
                };
                setEditingAnswer(normalizedAnswer);
            };

            const handleUpdateAnswer = async (e) => {
                e.preventDefault();
                if (!editingAnswer || !editingAnswer.title || editingAnswer.blocks.some(b => !b)) return;
                
                // Don't save the old 'text' field if it exists
                const { text, ...dataToSave } = editingAnswer;

                if (dataToSave.id) { // Editing existing
                    const { id, ...data } = dataToSave;
                    await fb.updateDoc(fb.doc(fb.db, "automaticAnswers", id), data);
                } else { // Adding new
                    const { id, ...data } = dataToSave;
                    await fb.addDoc(fb.collection(fb.db, "automaticAnswers"), data);
                }
                setEditingAnswer(null);
            };
            
            const handleModalChange = (field, value) => {
                 setEditingAnswer(prev => ({ ...prev, [field]: value }));
            };
            
            const handleBlockChange = (index, value) => {
                const newBlocks = [...editingAnswer.blocks];
                newBlocks[index] = value;
                handleModalChange('blocks', newBlocks);
            };

            const addBlock = () => {
                handleModalChange('blocks', [...editingAnswer.blocks, '']);
            };

            const removeBlock = (index) => {
                 if (editingAnswer.blocks.length > 1) {
                    const newBlocks = editingAnswer.blocks.filter((_, i) => i !== index);
                    handleModalChange('blocks', newBlocks);
                } else {
                    alert("You must have at least one block.");
                }
            };

            const handleDeleteAnswer = async (id) => {
                if (window.confirm("Are you sure you want to delete this answer permanently?")) {
                    await fb.deleteDoc(fb.doc(fb.db, "automaticAnswers", id));
                }
            };

            const copyToClipboard = (blocks) => {
                const finalText = (blocks || []).map(b => b.replace(/\[NAME\]/g, selectedName)).join('\n\n');
                navigator.clipboard.writeText(finalText).then(() => {
                    alert('Text copied!');
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Error while copying.');
                });
            };

            return (
                 <div>
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex items-center">
                           <label htmlFor="operator-select" className="mr-4 font-semibold text-gray-700">Operator Name:</label>
                            <select id="operator-select" value={selectedName} onChange={e => setSelectedName(e.target.value)}
                                className="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                {operators.map(name => <option key={name} value={name}>{name}</option>)}
                            </select>
                        </div>
                        {!readonly && (
                            <button onClick={openAddModal} className="px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700">Add New Answer</button>
                        )}
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                         {answers.length === 0 && <p>Loading answers...</p>}
                        {answers.map(answer => (
                            <div key={answer.id} className="bg-white p-6 rounded-lg shadow-md flex flex-col">
                                <h3 className="text-lg font-bold text-gray-800 mb-3">{answer.title}</h3>
                                <div className="text-gray-600 whitespace-pre-wrap flex-grow text-sm">
                                   {(answer.blocks || [answer.text]).map((block, index) => (
                                        <p key={index} className={index > 0 ? "mt-4" : ""}>
                                            {block.replace(/\[NAME\]/g, selectedName)}
                                        </p>
                                    ))}
                                </div>
                                <div className="mt-4 self-start flex gap-2">
                                    <button onClick={() => copyToClipboard(answer.blocks || [answer.text])}
                                        className="px-3 py-1 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                        Copy
                                    </button>
                                    {!readonly && (
                                        <Fragment>
                                             <button onClick={() => handleEditClick(answer)}
                                                className="px-3 py-1 text-sm font-medium text-white bg-yellow-500 rounded-md hover:bg-yellow-600">
                                                Edit
                                            </button>
                                            <button onClick={() => handleDeleteAnswer(answer.id)}
                                                className="px-3 py-1 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                                                Delete
                                            </button>
                                        </Fragment>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {editingAnswer && (
                        <Modal onClose={() => setEditingAnswer(null)}>
                            <h3 className="text-lg font-bold mb-4">{editingAnswer.id ? 'Edit' : 'Add New'} Automatic Answer</h3>
                            <form onSubmit={handleUpdateAnswer}>
                                <div className="space-y-4">
                                     <input type="text" placeholder="Title" value={editingAnswer.title} onChange={e => handleModalChange('title', e.target.value)} className="w-full p-2 border rounded" required/>
                                     <hr/>
                                     <h4 className="font-semibold">Message Blocks</h4>
                                     {editingAnswer.blocks.map((block, index) => (
                                        <div key={index} className="flex items-start gap-2">
                                            <textarea 
                                                placeholder={index === 0 ? "Main block... Use [NAME] for operator." : "Additional block..."}
                                                value={block} 
                                                onChange={e => handleBlockChange(index, e.target.value)} 
                                                className="w-full p-2 border rounded h-24" 
                                                required 
                                            />
                                             {editingAnswer.blocks.length > 1 && (
                                                <button type="button" onClick={() => removeBlock(index)} className="px-2 py-1 text-red-500 hover:text-red-700 text-2xl">&times;</button>
                                             )}
                                        </div>
                                     ))}
                                     <button type="button" onClick={addBlock} className="text-sm text-blue-600 hover:underline">+ Add another block</button>
                                </div>
                                <div className="mt-6 flex justify-end gap-4">
                                    <button type="button" onClick={() => setEditingAnswer(null)} className="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                                    <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        }
        
        function ServiceInfo({ readonly }) {
            const [services, setServices] = useState([]);
            const [selectedService, setSelectedService] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [newService, setNewService] = useState({ name: '', what: '', signs: '', process: '', price: '', duration: '', frequency: '', note: '' });

            useEffect(() => {
                const servicesCol = fb.collection(fb.db, "services");
                const unsubscribe = fb.onSnapshot(servicesCol, (snapshot) => {
                    const fetchedServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setServices(fetchedServices);
                });
                return () => unsubscribe();
            }, []);

            const handleAddService = async (e) => {
                e.preventDefault();
                if (!newService.name) return;
                await fb.addDoc(fb.collection(fb.db, "services"), newService);
                setNewService({ name: '', what: '', signs: '', process: '', price: '', duration: '', frequency: '', note: '' });
                setShowModal(false);
            };
            
            const handleDeleteService = async (id) => {
                if (window.confirm("Are you sure you want to delete this service permanently?")) {
                    try {
                        await fb.deleteDoc(fb.doc(fb.db, "services", id));
                        setSelectedService(null); // Close the modal
                    } catch (error) {
                        console.error("Error deleting service: ", error);
                        alert("Failed to delete service.");
                    }
                }
            };

            const InfoItem = ({label, value}) => (
                <p><strong className="font-semibold text-gray-900">{label}:</strong> {value}</p>
            );

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Service Information</h2>
                        {!readonly && (
                             <button onClick={() => setShowModal(true)} className="px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700">Add New Service</button>
                        )}
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                         {services.length === 0 && <p>Loading services...</p>}
                        {services.map(service => (
                            <div key={service.id} onClick={() => setSelectedService(service)}
                                className="bg-white p-6 rounded-lg shadow-lg cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all transform flex flex-col justify-between">
                                <h3 className="text-xl font-bold text-gray-900">{service.name}</h3>
                                <p className="text-blue-600 font-semibold mt-2">{service.price}</p>
                            </div>
                        ))}
                    </div>
                    {selectedService && (
                        <Modal onClose={() => setSelectedService(null)}>
                            <h2 className="text-2xl font-bold mb-4">{selectedService.name}</h2>
                            <div className="space-y-3 text-gray-700">
                                <InfoItem label="What We Do" value={selectedService.what} />
                                <InfoItem label="Signs You Need This" value={selectedService.signs} />
                                <InfoItem label="Our Process" value={selectedService.process} />
                                <InfoItem label="Price" value={selectedService.price} />
                                <InfoItem label="Duration" value={selectedService.duration} />
                                <InfoItem label="Frequency" value={selectedService.frequency} />
                                <InfoItem label="Note" value={selectedService.note} />
                            </div>
                            {!readonly && (
                                <div className="mt-6 pt-4 border-t flex justify-end">
                                    <button
                                        onClick={() => handleDeleteService(selectedService.id)}
                                        className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700"
                                    >
                                        Delete Service
                                    </button>
                                </div>
                            )}
                        </Modal>
                    )}
                    {showModal && (
                        <Modal onClose={() => setShowModal(false)}>
                            <h3 className="text-lg font-bold mb-4">Add New Service</h3>
                            <form onSubmit={handleAddService} className="space-y-4">
                                 <input type="text" placeholder="Service Name" value={newService.name} onChange={e => setNewService({...newService, name: e.target.value})} className="w-full p-2 border rounded" required/>
                                 <textarea placeholder="What we do..." value={newService.what} onChange={e => setNewService({...newService, what: e.target.value})} className="w-full p-2 border rounded h-24" />
                                 <textarea placeholder="Signs you need this..." value={newService.signs} onChange={e => setNewService({...newService, signs: e.target.value})} className="w-full p-2 border rounded h-24" />
                                 <textarea placeholder="Our process..." value={newService.process} onChange={e => setNewService({...newService, process: e.target.value})} className="w-full p-2 border rounded h-24" />
                                 <input type="text" placeholder="Price" value={newService.price} onChange={e => setNewService({...newService, price: e.target.value})} className="w-full p-2 border rounded" />
                                 <input type="text" placeholder="Duration" value={newService.duration} onChange={e => setNewService({...newService, duration: e.target.value})} className="w-full p-2 border rounded" />
                                 <input type="text" placeholder="Frequency" value={newService.frequency} onChange={e => setNewService({...newService, frequency: e.target.value})} className="w-full p-2 border rounded" />
                                 <input type="text" placeholder="Note" value={newService.note} onChange={e => setNewService({...newService, note: e.target.value})} className="w-full p-2 border rounded" />
                                <div className="mt-6 flex justify-end gap-4">
                                    <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                                    <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        }

        function PropertyManagement({ readonly }) {
            const [properties, setProperties] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [newProperty, setNewProperty] = useState({ Company: '', Phone: '', Email: '', Representative: '', "Invoicing Email": ""});
            const [searchTerm, setSearchTerm] = useState("");

             useEffect(() => {
                const propertiesCol = fb.collection(fb.db, "propertyManagement");
                const unsubscribe = fb.onSnapshot(propertiesCol, (snapshot) => {
                    const fetchedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProperties(fetchedData);
                });
                return () => unsubscribe();
            }, []);
            
            const handleAddProperty = async (e) => {
                e.preventDefault();
                if (!newProperty.Company) return;
                await fb.addDoc(fb.collection(fb.db, "propertyManagement"), newProperty);
                setNewProperty({ Company: '', Phone: '', Email: '', Representative: '', "Invoicing Email": ""});
                setShowModal(false);
            };

            const handleUpdate = async (id, field, value) => {
                const docRef = fb.doc(fb.db, "propertyManagement", id);
                await fb.updateDoc(docRef, { [field]: value });
            };

            const filteredProperties = properties.filter(prop => 
                (prop.Company && prop.Company.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (prop.Representative && prop.Representative.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (prop.Email && prop.Email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (prop["Invoicing Email"] && prop["Invoicing Email"].toLowerCase().includes(searchTerm.toLowerCase()))
            );
            
            return (
                 <div>
                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 className="text-2xl font-bold text-gray-800">Property Management</h2>
                        <div className="flex items-center gap-4">
                           <input 
                                type="text" 
                                placeholder="Search..." 
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="px-4 py-2 border border-gray-300 rounded-lg"
                            />
                           {!readonly && (
                            <button onClick={() => setShowModal(true)} className="px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700">Add New Company</button>
                           )}
                        </div>
                    </div>
                     <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {filteredProperties.map(prop => (
                            <div key={prop.id} className="bg-white rounded-lg shadow-md p-6 space-y-3">
                                <h3 className="text-xl font-bold text-gray-900"><EditableCell value={prop.Company} onSave={val => handleUpdate(prop.id, 'Company', val)} readonly={readonly} /></h3>
                                <p className="text-sm text-gray-600"><strong>Rep:</strong> <EditableCell value={prop.Representative} onSave={val => handleUpdate(prop.id, 'Representative', val)} readonly={readonly} /></p>
                                <p className="text-sm text-gray-600"><strong>Phone:</strong> <EditableCell value={prop.Phone} onSave={val => handleUpdate(prop.id, 'Phone', val)} readonly={readonly} /></p>
                                <p className="text-sm text-gray-600"><strong>Email:</strong> <EditableCell value={prop.Email} onSave={val => handleUpdate(prop.id, 'Email', val)} readonly={readonly} /></p>
                                <p className="text-sm text-gray-600"><strong>Invoice Email:</strong> <EditableCell value={prop["Invoicing Email"]} onSave={val => handleUpdate(prop.id, 'Invoicing Email', val)} readonly={readonly} /></p>
                            </div>
                        ))}
                    </div>

                    {showModal && (
                        <Modal onClose={() => setShowModal(false)}>
                            <h3 className="text-lg font-bold mb-4">Add New Company</h3>
                            <form onSubmit={handleAddProperty} className="space-y-4">
                                     <input type="text" placeholder="Company Name" value={newProperty.Company} onChange={e => setNewProperty({...newProperty, Company: e.target.value})} className="w-full p-2 border rounded" required/>
                                     <input type="text" placeholder="Representative" value={newProperty.Representative} onChange={e => setNewProperty({...newProperty, Representative: e.target.value})} className="w-full p-2 border rounded" />
                                     <input type="tel" placeholder="Phone" value={newProperty.Phone} onChange={e => setNewProperty({...newProperty, Phone: e.target.value})} className="w-full p-2 border rounded" />
                                     <input type="email" placeholder="Contact Email" value={newProperty.Email} onChange={e => setNewProperty({...newProperty, Email: e.target.value})} className="w-full p-2 border rounded" />
                                     <input type="email" placeholder="Invoicing Email" value={newProperty["Invoicing Email"]} onChange={e => setNewProperty({...newProperty, "Invoicing Email": e.target.value})} className="w-full p-2 border rounded" />
                                <div className="mt-6 flex justify-end gap-4">
                                    <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                                    <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            )
        }
        
        function OutstandingPayments({ readonly }) {
            const [payments, setPayments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [newPayment, setNewPayment] = useState({ CUSTOMER: '', 'PHONE NUMBER': '', EMAIL: '', AMMOUNT: '', 'INVOICE No': '', STATUS: 'OUTSTANDING', 'INVOICE DATE': '' });
            const [showArchived, setShowArchived] = useState(false);

            useEffect(() => {
                setLoading(true);
                const status = showArchived ? 'PAID' : 'OUTSTANDING';
                const paymentsCol = fb.query(fb.collection(fb.db, "outstandingPayments"), fb.where("STATUS", "==", status));
                const unsubscribe = fb.onSnapshot(paymentsCol, (snapshot) => {
                    const fetchedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPayments(fetchedData);
                    setLoading(false);
                }, (error) => {
                     console.error("Error fetching payments:", error);
                     setLoading(false);
                });
                return () => unsubscribe();
            }, [showArchived]);
            
            const handleCsvUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length < 2) {
                            alert("CSV file is empty or contains only a header.");
                            return;
                        }

                        const fileHeaders = lines[0].split(',').map(h => h.trim().toUpperCase());

                        const keyMap = {
                            'INVOICE No': ['INVOICE #', 'INVOICE NO'],
                            'CUSTOMER': ['CUSTOMER'],
                            'STATUS': ['INVOICE STATUS', 'STATUS'],
                            'AMMOUNT': ['AMOUNT DUE', 'AMMOUNT'],
                            'INVOICE DATE': ['LATEST SEND DATE', 'INVOICE DATE'],
                            'PHONE NUMBER': ['PHONE'],
                            'EMAIL': ['EMAIL']
                        };

                        const headerIndexMap = {};
                        for (const [internalKey, possibleHeaders] of Object.entries(keyMap)) {
                            for (const pHeader of possibleHeaders) {
                                const fileHeaderIndex = fileHeaders.indexOf(pHeader.toUpperCase());
                                if (fileHeaderIndex !== -1) {
                                    headerIndexMap[internalKey] = fileHeaderIndex;
                                    break;
                                }
                            }
                        }

                        if (headerIndexMap['INVOICE No'] === undefined) {
                            alert("CSV import failed. The file must contain an 'Invoice #' or 'INVOICE No' column.");
                            event.target.value = null;
                            return;
                        }

                        const records = lines.slice(1).map(line => {
                            const values = line.split(',');
                            const record = {};
                            for (const [internalKey, index] of Object.entries(headerIndexMap)) {
                                if (values[index] !== undefined) {
                                     record[internalKey] = values[index].trim();
                                }
                            }
                            return record;
                        });
                        
                        const batch = fb.writeBatch(fb.db);
                        
                        // NEW: Delete all existing payment records
                        const paymentsQuery = fb.query(fb.collection(fb.db, "outstandingPayments"));
                        const oldPaymentsSnap = await fb.getDocs(paymentsQuery);
                        oldPaymentsSnap.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        let newRecordsCount = 0;
                        records.forEach(record => {
                            const invoiceNo = record['INVOICE No'];
                            if (invoiceNo) { // Import all records from CSV
                                const amountStr = record['AMMOUNT'] || '0';
                                const cleanedAmountStr = amountStr.replace(/[^0-9.-]+/g,"");
                                const amount = parseFloat(cleanedAmountStr) || 0;

                                let status = (record['STATUS'] || 'OUTSTANDING').toUpperCase();
                                if (status !== 'PAID') {
                                    status = 'OUTSTANDING';
                                }

                                const newPaymentData = {
                                    'CUSTOMER': record['CUSTOMER'] || '',
                                    'PHONE NUMBER': record['PHONE NUMBER'] || '',
                                    'EMAIL': record['EMAIL'] || '',
                                    'AMMOUNT': amount,
                                    'INVOICE No': invoiceNo,
                                    'STATUS': status,
                                    'INVOICE DATE': record['INVOICE DATE'] || new Date().toLocaleDateString('en-US')
                                };
                                const docRef = fb.doc(fb.collection(fb.db, "outstandingPayments"));
                                batch.set(docRef, newPaymentData);
                                newRecordsCount++;
                            }
                        });

                        await batch.commit();
                        alert(`Import complete! ${oldPaymentsSnap.docs.length} old records deleted and ${newRecordsCount} new records imported.`);

                    } catch (error) {
                        console.error("CSV Import Error:", error);
                        alert("An error occurred during the CSV import. Please check the console for details.");
                    } finally {
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            };

            const handleUpdate = async (id, field, value) => {
                const docRef = fb.doc(fb.db, "outstandingPayments", id);
                await fb.updateDoc(docRef, { [field]: value });
            };

            const handleAdd = async (e) => {
                e.preventDefault();
                if(!newPayment.CUSTOMER || !newPayment.AMMOUNT) return;
                const paymentToAdd = {
                    ...newPayment,
                    AMMOUNT: parseFloat(newPayment.AMMOUNT)
                }
                await fb.addDoc(fb.collection(fb.db, "outstandingPayments"), paymentToAdd);
                setNewPayment({ CUSTOMER: '', 'PHONE NUMBER': '', EMAIL: '', AMMOUNT: '', 'INVOICE No': '', STATUS: 'OUTSTANDING', 'INVOICE DATE': '' });
                setShowModal(false);
            };

            const totalAmountDue = payments
                .filter(p => p.STATUS === 'OUTSTANDING')
                .reduce((sum, p) => sum + (Number(p.AMMOUNT) || 0), 0);

            const calculateDueDays = (invoiceDateStr) => {
                if (!invoiceDateStr) return 'N/A';
                const invoiceDate = new Date(invoiceDateStr);
                if (isNaN(invoiceDate.getTime())) return 'Invalid Date';
                
                const today = new Date();
                // Set hours to 0 to compare dates only
                today.setHours(0, 0, 0, 0);
                invoiceDate.setHours(0, 0, 0, 0);

                const differenceInTime = today.getTime() - invoiceDate.getTime();
                const differenceInDays = Math.floor(differenceInTime / (1000 * 3600 * 24));
                return differenceInDays;
            };

            return (
                <div>
                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 className="text-2xl font-bold text-gray-800">Outstanding Payments</h2>
                         <div className="flex items-center gap-4">
                            {!readonly && (
                                <Fragment>
                                    <label className="px-4 py-2 text-white bg-purple-600 rounded-lg hover:bg-purple-700 cursor-pointer">
                                        Import & Replace All
                                        <input type="file" accept=".csv" onChange={handleCsvUpload} className="hidden" />
                                    </label>
                                    <button onClick={() => setShowModal(true)} className="px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700">Add New</button>
                                </Fragment>
                            )}
                             <button onClick={() => setShowArchived(!showArchived)} className="px-4 py-2 text-white bg-gray-500 rounded-lg hover:bg-gray-600">
                                {showArchived ? 'Show Outstanding' : 'Show Archive (Paid)'}
                            </button>
                         </div>
                    </div>
                    {!showArchived && <div className="mb-4 text-lg font-semibold">Total Amount Due: <span className="text-red-600">${totalAmountDue.toFixed(2)}</span></div>}
                     <div className="overflow-x-auto bg-white rounded-lg shadow">
                         <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    {['Invoice #', 'Customer', 'Invoice status', 'Amount due', 'Latest send date', 'Due Days', 'Email', 'Phone'].map(h => <th key={h} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{h}</th>)}
                                </tr>
                             </thead>
                             <tbody className="bg-white divide-y divide-gray-200">
                                {loading && (<tr><td colSpan="8" className="text-center py-4">Loading payments...</td></tr>)}
                                {!loading && payments.map(p => (
                                    <tr key={p.id} className="hover:bg-gray-50 odd:bg-white even:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm"><EditableCell readonly={readonly} value={p['INVOICE No']} onSave={val => handleUpdate(p.id, 'INVOICE No', val)} /></td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm"><EditableCell readonly={readonly} value={p.CUSTOMER} onSave={val => handleUpdate(p.id, 'CUSTOMER', val)} /></td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                            <select value={p.STATUS} disabled={readonly} onChange={e => handleUpdate(p.id, 'STATUS', e.target.value)}
                                                className={`p-2 rounded border-transparent ${p.STATUS === 'PAID' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                <option value="OUTSTANDING">OUTSTANDING</option>
                                                <option value="PAID">PAID</option>
                                            </select>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">$<EditableCell readonly={readonly} type="number" value={p.AMMOUNT} onSave={val => handleUpdate(p.id, 'AMMOUNT', parseFloat(val))} /></td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm"><EditableCell readonly={readonly} type="date" value={p['INVOICE DATE']} onSave={val => handleUpdate(p.id, 'INVOICE DATE', val)} /></td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">{calculateDueDays(p['INVOICE DATE'])}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm"><EditableCell readonly={readonly} value={p.EMAIL} onSave={val => handleUpdate(p.id, 'EMAIL', val)} /></td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm"><EditableCell readonly={readonly} value={p['PHONE NUMBER']} onSave={val => handleUpdate(p.id, 'PHONE NUMBER', val)} /></td>
                                    </tr>
                                ))}
                            </tbody>
                         </table>
                     </div>
                      {showModal && (
                        <Modal onClose={() => setShowModal(false)}>
                            <h3 className="text-lg font-bold mb-4">Add New Payment</h3>
                            <form onSubmit={handleAdd} className="space-y-4">
                                     <input type="text" placeholder="Customer" value={newPayment.CUSTOMER} onChange={e => setNewPayment({...newPayment, CUSTOMER: e.target.value})} className="w-full p-2 border rounded" required/>
                                     <input type="text" placeholder="Phone Number" value={newPayment['PHONE NUMBER']} onChange={e => setNewPayment({...newPayment, 'PHONE NUMBER': e.target.value})} className="w-full p-2 border rounded" />
                                     <input type="email" placeholder="Email" value={newPayment.EMAIL} onChange={e => setNewPayment({...newPayment, EMAIL: e.target.value})} className="w-full p-2 border rounded" />
                                     <input type="number" step="0.01" placeholder="Amount Due" value={newPayment.AMMOUNT} onChange={e => setNewPayment({...newPayment, AMMOUNT: e.target.value})} className="w-full p-2 border rounded" required />
                                     <input type="text" placeholder="Invoice #" value={newPayment['INVOICE No']} onChange={e => setNewPayment({...newPayment, 'INVOICE No': e.target.value})} className="w-full p-2 border rounded" />
                                     <input type="date" placeholder="Latest Send Date" value={newPayment['INVOICE DATE']} onChange={e => setNewPayment({...newPayment, 'INVOICE DATE': e.target.value})} className="w-full p-2 border rounded" />
                                <div className="mt-6 flex justify-end gap-4">
                                    <button type="button" onClick={() => setShowModal(false)} className="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                                    <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        }

        function AdminFiles({ readonly }) {
            const [files, setFiles] = useState([]);
            const [uploading, setUploading] = useState(false);

            useEffect(() => {
                const filesCol = fb.collection(fb.db, "administrativeFiles");
                const unsubscribe = fb.onSnapshot(filesCol, (snapshot) => {
                    const fetchedFiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setFiles(fetchedFiles);
                });
                return () => unsubscribe();
            }, []);

            const handleUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (file.size > 1024 * 1024) {
                    alert("File is too large. The maximum size is 1MB.");
                    return;
                }

                setUploading(true);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    try {
                        await fb.addDoc(fb.collection(fb.db, "administrativeFiles"), {
                            name: file.name,
                            type: file.type,
                            dataUrl: reader.result
                        });
                        alert("File uploaded successfully!");
                    } catch (error) {
                        console.error("File upload error: ", error);
                        alert("Failed to upload file.");
                    } finally {
                        setUploading(false);
                    }
                };
                reader.onerror = (error) => {
                    console.error("File reading error: ", error);
                    alert("Failed to read file.");
                    setUploading(false);
                };
            };
            
            const handleDelete = async (id, name) => {
                 if (window.confirm(`Are you sure you want to delete the file "${name}"?`)) {
                    await fb.deleteDoc(fb.doc(fb.db, "administrativeFiles", id));
                 }
            }

            return (
                 <div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Administrative Files</h2>
                     {!readonly && (
                        <Fragment>
                            <div className="mb-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded" role="alert">
                              <p className="font-bold">Important Note</p>
                              <p>File storage is handled by Firestore to stay on the free plan. The maximum file size is 1MB.</p>
                            </div>
                            <div className="mb-6">
                                <label className="block mb-2 text-sm font-medium text-gray-900" htmlFor="file_input">Upload File</label>
                                <input onChange={handleUpload} disabled={uploading}
                                    className="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none"
                                    id="file_input" type="file" />
                                 {uploading && <p className="mt-2 text-sm text-blue-600">Uploading...</p>}
                            </div>
                        </Fragment>
                    )}

                    <div className="bg-white p-4 rounded-lg shadow">
                         <h3 className="font-semibold mb-4">Uploaded Files:</h3>
                         <ul className="space-y-2">
                             {files.map(file => (
                                 <li key={file.id} className="flex justify-between items-center p-2 rounded hover:bg-gray-100">
                                     <span className="text-gray-700">{file.name}</span>
                                     <div className="flex items-center gap-4">
                                        <a href={file.dataUrl} download={file.name} className="px-3 py-1 text-sm text-white bg-blue-500 rounded hover:bg-blue-600">
                                             Download
                                        </a>
                                        {!readonly && (
                                            <button onClick={() => handleDelete(file.id, file.name)} className="px-3 py-1 text-sm text-white bg-red-500 rounded hover:bg-red-600">Delete</button>
                                        )}
                                     </div>
                                 </li>
                             ))}
                         </ul>
                         {files.length === 0 && <p className="text-gray-500">No files found.</p>}
                    </div>
                 </div>
            );
        }
        
        // --- Utility Components ---
        function Modal({ children, onClose }) {
            return (
                <div className="modal-backdrop" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-2xl leading-none">&times;</button>
                        {children}
                    </div>
                </div>
            );
        }

        function EditableCell({ value, onSave, type = 'text', readonly = false }) {
            const [editing, setEditing] = useState(false);
            const [currentValue, setCurrentValue] = useState(value);

            const handleSave = () => {
                onSave(currentValue);
                setEditing(false);
            };

            if (readonly) {
                return <span>{value || "-"}</span>;
            }
            
            if (type === 'date' && editing) {
                const dateValue = currentValue ? new Date(currentValue).toISOString().split('T')[0] : '';
                 return (
                    <input
                        type="date"
                        value={dateValue}
                        onChange={(e) => setCurrentValue(new Date(e.target.value).toLocaleDateString('en-US'))}
                        onBlur={handleSave}
                        onKeyDown={(e) => e.key === 'Enter' && handleSave()}
                        autoFocus
                        className="w-full p-1 border rounded bg-yellow-50"
                    />
                );
            }

            if (editing) {
                return (
                    <input
                        type={type}
                        value={currentValue}
                        onChange={(e) => setCurrentValue(e.target.value)}
                        onBlur={handleSave}
                        onKeyDown={(e) => e.key === 'Enter' && handleSave()}
                        autoFocus
                        className="w-full p-1 border rounded bg-yellow-50"
                    />
                );
            }
            return <span onClick={() => setEditing(true)} className="cursor-pointer hover:bg-yellow-100 p-1 rounded">{value || "-"}</span>;
        }

        function ScheduleTable({ scheduleId, title, readonly }) {
            const [scheduleData, setScheduleData] = useState({ headers: [], rows: [] });

            useEffect(() => {
                const scheduleRef = fb.doc(fb.db, "schedules", scheduleId);
                const unsubscribe = fb.onSnapshot(scheduleRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        try {
                            const rows = data.rowsJSON ? JSON.parse(data.rowsJSON) : (data.rows || []);
                            setScheduleData({ headers: data.headers || [], rows: rows });
                        } catch (e) { console.error("Failed to parse schedule rows:", e); }
                    }
                });
                return () => unsubscribe();
            }, [scheduleId]);
            
            const handleCellChange = (rowIndex, colIndex, value) => {
                const newRows = [...scheduleData.rows];
                newRows[rowIndex][colIndex] = value;
                const scheduleRef = fb.doc(fb.db, "schedules", scheduleId);
                fb.updateDoc(scheduleRef, { rowsJSON: JSON.stringify(newRows) });
            };

            const handleHeaderChange = (colIndex, value) => {
                const newHeaders = [...scheduleData.headers];
                newHeaders[colIndex] = value;
                const scheduleRef = fb.doc(fb.db, "schedules", scheduleId);
                fb.updateDoc(scheduleRef, { headers: newHeaders });
            };
            
            const addEmployee = () => {
                const name = prompt("Enter new employee's name:");
                if(name && name.trim() !== "") {
                    const newHeaders = [...scheduleData.headers, name.trim()];
                    const newRows = scheduleData.rows.map(row => [...row, 'OFF']);
                    const scheduleRef = fb.doc(fb.db, "schedules", scheduleId);
                    fb.updateDoc(scheduleRef, { headers: newHeaders, rowsJSON: JSON.stringify(newRows) });
                }
            };
            
            const deleteEmployee = (colIndex) => {
                if (window.confirm(`Are you sure you want to delete ${scheduleData.headers[colIndex]}?`)) {
                    const newHeaders = scheduleData.headers.filter((_, i) => i !== colIndex);
                    const newRows = scheduleData.rows.map(row => row.filter((_, i) => i !== colIndex));
                    const scheduleRef = fb.doc(fb.db, "schedules", scheduleId);
                    fb.updateDoc(scheduleRef, { headers: newHeaders, rowsJSON: JSON.stringify(newRows) });
                }
            };

            return (
                 <div className="bg-white rounded-lg shadow p-4 flex flex-col">
                     <h3 className="text-lg font-bold text-gray-800 mb-4">{title}</h3>
                     <div className="overflow-x-auto flex-grow">
                         <table className="w-full text-sm text-left text-gray-500">
                             <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                 <tr>
                                     {scheduleData.headers.map((header, index) => (
                                         <th key={index} className="px-4 py-2 relative">
                                             <EditableCell readonly={readonly || index === 0} value={header} onSave={(value) => handleHeaderChange(index, value)} />
                                             {!readonly && index > 0 && (
                                                <span className="trash-icon" onClick={() => deleteEmployee(index)}>
                                                    &#128465;
                                                </span>
                                             )}
                                         </th>
                                     ))}
                                 </tr>
                             </thead>
                             <tbody>
                                {scheduleData.rows.map((row, rowIndex) => (
                                     <tr key={rowIndex} className="bg-white border-b hover:bg-gray-50">
                                         {row.map((cell, colIndex) => (
                                             <td key={colIndex} className="px-4 py-2">
                                                 <EditableCell readonly={readonly || colIndex === 0} value={cell} onSave={(value) => handleCellChange(rowIndex, colIndex, value)} />
                                             </td>
                                         ))}
                                     </tr>
                                 ))}
                             </tbody>
                         </table>
                     </div>
                     {!readonly && (
                        <button onClick={addEmployee} className="mt-4 self-start px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                            Add New {title.includes("Operator") ? "Operator" : "Manager"}
                        </button>
                     )}
                 </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
